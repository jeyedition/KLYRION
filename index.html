<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KLYRION TV</title>
<link rel="stylesheet" href="style.css">

<!-- ANDROID TV -->
<meta name="tv:immersive" content="true">
</head>

<body>

  <!-- SPLASH ANDROID TV -->
<div id="splash">
  <div class="splash-box">
    <img src="logo.svg" alt="KLYRION">
    <span>Cargandoâ€¦</span>
  </div>
</div>


  
<header class="topbar">
  <h1>KLYRION TV</h1>
  <button onclick="show('iptv')">EN VIVO</button>
  <button onclick="m3uInput.click()">IMPORTAR M3U</button>
</header>

<input type="file" id="m3uInput" accept=".m3u,.txt" hidden>

<main id="content"></main>

<script>

// SPLASH
window.onload = ()=>{
  setTimeout(()=>{
    document.getElementById("splash").style.opacity="0";
    setTimeout(()=>{
      document.getElementById("splash").style.display="none";
    },600);
  },2000);
};


  
const DATA_URL = "data.json";
const EPG_URL = "epg.xml";   // tu XMLTV
let DATA = {};
let CURRENT = [];
let EPG = {};

/* CARGA */
async function loadData(){
  const r = await fetch(DATA_URL);
  DATA = await r.json();
  await loadEPG();
  show("iptv");
}

/* EPG */
async function loadEPG(){
  try{
    const r = await fetch(EPG_URL);
    const t = await r.text();
    const xml = new DOMParser().parseFromString(t,"text/xml");
    xml.querySelectorAll("programme").forEach(p=>{
      const id = p.getAttribute("channel");
      const title = p.querySelector("title")?.textContent || "";
      const start = p.getAttribute("start");
      if(!EPG[id]) EPG[id]=[];
      EPG[id].push({title,start});
    });
  }catch(e){}
}

/* MOSTRAR */
function show(type){
  CURRENT = DATA[type] || [];
  render(CURRENT);
}

/* RENDER TV + EPG */
function render(list){
  content.innerHTML="";
  list.forEach(item=>{
    const now = EPG[item.id]?.[0]?.title || "En vivo";
    const next = EPG[item.id]?.[1]?.title || "";
    const card = document.createElement("div");
    card.className="tv-card";
    card.tabIndex=0;
    card.innerHTML=`
      <img src="${item.img}">
      <div class="tv-title">${item.title}</div>
      <div class="epg-now">Ahora: ${now}</div>
      <div class="epg-next">${next ? "Luego: "+next : ""}</div>
    `;
    card.onclick = ()=> openExternal(item.url);
    content.appendChild(card);
  });
}

/* REPRODUCTOR EXTERNO */
function openExternal(url){
  window.location.href = url;
}

/* IMPORTAR M3U */
m3uInput.onchange = e =>{
  const reader = new FileReader();
  reader.onload = ()=> parseM3U(reader.result);
  reader.readAsText(e.target.files[0]);
};

function parseM3U(text){
  const lines = text.split("\n");
  const list = [];
  let name = "";
  lines.forEach(l=>{
    if(l.startsWith("#EXTINF")){
      name = l.split(",").pop().trim();
    }
    if(l.startsWith("http")){
      list.push({
        id: name.toLowerCase().replace(/\s+/g,"."),
        title: name,
        img: "https://via.placeholder.com/320x180.webp",
        url: l.trim()
      });
    }
  });
  render(list);
}

loadData();
</script>

</body>
</html>
