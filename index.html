<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPTV Smarters Style</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="splash">Cargando…</div>

<!-- CONTROLES -->
<div id="controls">
  <input id="urlInput" type="text" placeholder="Pegar link M3U/M3U8">
  <button onclick="loadFromURL()">Cargar link</button>
  <input type="file" accept=".m3u,.m3u8" onchange="loadFromFile(this)">
</div>

<!-- LAYOUT -->
<div id="layout">
  <div id="groups"></div>
  <div id="channels"></div>
</div>

<!-- PLAYER -->
<div id="playerBox">
  <video id="player" controls autoplay></video>
  <button onclick="closePlayer()">✕</button>
</div>

<script>
let DATA = {};
let CURRENT_GROUP = "";

/* --------- CARGA --------- */
function loadFromURL(){
  const url = urlInput.value.trim();
  if(!url) return;
  fetch(url).then(r=>r.text()).then(parseM3U).catch(()=>alert("No se pudo cargar"));
}

function loadFromFile(input){
  const f = input.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = e => parseM3U(e.target.result);
  r.readAsText(f);
}

/* --------- PARSE M3U (con grupos) --------- */
function parseM3U(text){
  const lines = text.split(/\r?\n/);
  let title="", group="Otros";
  const data = {};

  lines.forEach(l=>{
    l=l.trim();
    if(l.startsWith("#EXTINF")){
      const g = l.match(/group-title="([^"]+)"/);
      group = g ? g[1] : "Otros";
      title = l.split(",").pop().trim();
    } else if(l.startsWith("http")){
      if(!data[group]) data[group]=[];
      data[group].push({ title: title||"Canal", url:l });
      title="";
    }
  });

  DATA = data;
  localStorage.setItem("IPTV_SMARTERS", JSON.stringify(DATA));
  renderGroups();
}

/* --------- UI --------- */
function renderGroups(){
  const g = document.getElementById("groups");
  g.innerHTML="";
  Object.keys(DATA).forEach(k=>{
    const d=document.createElement("div");
    d.className="group";
    d.textContent=k;
    d.onclick=()=>selectGroup(k);
    g.appendChild(d);
  });
  const first = Object.keys(DATA)[0];
  if(first) selectGroup(first);
}

function selectGroup(name){
  CURRENT_GROUP=name;
  renderChannels();
  document.querySelectorAll(".group").forEach(el=>{
    el.classList.toggle("active", el.textContent===name);
  });
}

function renderChannels(){
  const c=document.getElementById("channels");
  c.innerHTML="";
  DATA[CURRENT_GROUP].forEach(ch=>{
    const d=document.createElement("div");
    d.className="channel";
    d.textContent=ch.title;
    d.onclick=()=>play(ch.url);
    c.appendChild(d);
  });
}

/* --------- PLAYER (interno + VLC) --------- */
function play(url){
  const lower=url.toLowerCase();
  const external=[".avi",".flv"];

  if(external.some(e=>lower.endsWith(e))){
    openExternal(url); return;
  }

  try{
    playerBox.style.display="flex";
    player.src=url;
    player.play();
    player.onerror=()=>openExternal(url);
  }catch(e){ openExternal(url); }
}

function openExternal(url){
  alert("Se abrirá en un reproductor externo (VLC/MX)");
  window.location.href=url;
}

function closePlayer(){
  player.pause(); player.src="";
  playerBox.style.display="none";
}

/* --------- AUTOLOAD --------- */
(function(){
  const s=localStorage.getItem("IPTV_SMARTERS");
  if(s){
    try{ DATA=JSON.parse(s); renderGroups(); }catch(e){}
  }
})();

window.onload=()=>{
  setTimeout(()=>{
    splash.style.opacity=0;
    setTimeout(()=>splash.remove(),400);
  },600);
};
</script>

</body>
</html>
